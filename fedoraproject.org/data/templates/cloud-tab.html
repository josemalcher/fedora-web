<?python
# This file is used to generate the "out/static/js/cloud_ec2.js" file snd the get-fedora-options#cloud tab
# You should only edit
# - the bellow dictionnary containing the AMI ID (get them on the wiki)
# - the two python list ec2_fXX_regions
# - the template call at the end of file near "noscript" and "if JS enabled".

# Returns a sorted list of unique available regions from the array
def sorted_region(arr):
	list = []
	for i in arr:
		list.append(i['region'])
	return(sorted(set(list), key=lambda  item: (int(item.partition(' ')[0]) if item[0].isdigit() else float('inf'), item)))

# see http://fedoraproject.org/wiki/Cloud_SIG/EC2_Images for the complet list
# Generated using the following:
# :%s#^| \([a-zA-Z*-9]*\)[ |]*\(i386\|x86_64\)[ |]*\(EBS-backed\)[ |]* \(ami.*\)#{'region':'\1', 'arch':'\2', 'store':'\3', 'id':'\4'},#g

ec2_f18 = [
			{'region':'ap-southeast-1', 'arch':'x86_64', 'store':'EBS-Backed', 'id':'ami-30aeec62'},
			{'region':'ap-southeast-1', 'arch':'i386',   'store':'EBS-Backed', 'id':'ami-caa9eb98'},
			{'region':'ap-southeast-2', 'arch':'x86_64', 'store':'EBS-Backed', 'id':'ami-9ae472a0'},
			{'region':'ap-southeast-2', 'arch':'i386',   'store':'EBS-Backed', 'id':'ami-dce771e6'},
			{'region':'ap-northeast-1', 'arch':'x86_64', 'store':'EBS-Backed', 'id':'ami-5f01bb5e'},
			{'region':'ap-northeast-1', 'arch':'i386',   'store':'EBS-Backed', 'id':'ami-7100ba70'},
			{'region':'us-east-1',      'arch':'x86_64', 'store':'EBS-Backed', 'id':'ami-6145cc08'},
			{'region':'us-east-1',      'arch':'i386',   'store':'EBS-Backed', 'id':'ami-0d44cd64'},
			{'region':'us-west-1',      'arch':'x86_64', 'store':'EBS-Backed', 'id':'ami-0899b94d'},
			{'region':'us-west-1',      'arch':'i386',   'store':'EBS-Backed', 'id':'ami-de99b99b'},
			{'region':'us-west-2',      'arch':'x86_64', 'store':'EBS-Backed', 'id':'ami-0266ed32'},
			{'region':'us-west-2',      'arch':'i386',   'store':'EBS-Backed', 'id':'ami-6467ec54'},
			{'region':'eu-west-1',      'arch':'x86_64', 'store':'EBS-Backed', 'id':'ami-bafcf3ce'},
			{'region':'eu-west-1',      'arch':'i386',   'store':'EBS-Backed', 'id':'ami-cafef1be'},
			{'region':'sa-east-1',      'arch':'x86_64', 'store':'EBS-Backed', 'id':'ami-81558d9c'},
			{'region':'sa-east-1',      'arch':'i386',   'store':'EBS-Backed', 'id':'ami-e5548cf8'}
]

ec2_f17 = [
			{'region':'ap-northeast-1', 'arch':'i386',   'store':'EBS-backed', 'id':'ami-5ae6555b'},
			{'region':'ap-northeast-1', 'arch':'x86_64', 'store':'EBS-backed', 'id':'ami-26e65527'},
			{'region':'ap-southeast-1', 'arch':'i386',   'store':'EBS-backed', 'id':'ami-cc86c09e'},
			{'region':'ap-southeast-1', 'arch':'x86_64', 'store':'EBS-backed', 'id':'ami-2e86c07c'},
			{'region':'ap-southeast-2', 'arch':'i386',   'store':'EBS-backed', 'id':'ami-87a433bd'},
			{'region':'ap-southeast-2', 'arch':'x86_64', 'store':'EBS-backed', 'id':'ami-e3a433d9'},
			{'region':'eu-west-1',      'arch':'i386',   'store':'EBS-backed', 'id':'ami-e981bb9d'},
			{'region':'eu-west-1',      'arch':'x86_64', 'store':'EBS-backed', 'id':'ami-9980baed'},
			{'region':'sa-east-1',      'arch':'i386',   'store':'EBS-backed', 'id':'ami-1ae33d07'},
			{'region':'sa-east-1',      'arch':'x86_64', 'store':'EBS-backed', 'id':'ami-eee23cf3'},
			{'region':'us-east-1',      'arch':'i386',   'store':'EBS-backed', 'id':'ami-08d97e61'},
			{'region':'us-east-1',      'arch':'x86_64', 'store':'EBS-backed', 'id':'ami-2ea50247'},
			{'region':'us-west-1',      'arch':'i386',   'store':'EBS-backed', 'id':'ami-417f2504'},
			{'region':'us-west-1',      'arch':'x86_64', 'store':'EBS-backed', 'id':'ami-877e24c2'},
			{'region':'us-west-2',      'arch':'i386',   'store':'EBS-backed', 'id':'ami-e269e5d2'},
			{'region':'us-west-2',      'arch':'x86_64', 'store':'EBS-backed', 'id':'ami-8e69e5be'}
]

ec2_f18_regions = sorted_region(ec2_f18)
ec2_f17_regions = sorted_region(ec2_f17)


# The idea is to get something similar to http://jsfiddle.net/shaiton/wChSv/5/
# But we have to generate it in order to have to maintain only one list of AMI ID
# Simply read the output at "out/static/js/cloud_ec2.js"
def gen_js(*args):
	js="// File generated from cloud-tab.html.\n"
	js+="window.onload=function(){\n"

	for release in args:
		js+="\tdocument.getElementById('cloud_options_" + release[0] + "').style.visibility='visible';\n"
		js+="\tdocument.getElementById('amihref_" + release[0] + "').style.visibility='hidden';\n"
	js+="}\n"

	js+="\nfunction getval() {\n"
	js+="\t// We get the number of regions, and define a two dimensional array (region,arch) to store the AMI ID\n"
	js+="\t// We limit to i > 1 as we don't need the first null entry'\n"
	js+="\t// For each release providen. '\n"
	for release in args:
		js+="\n\tvar form_" + release[0] + " = document.forms['cloud_options_" + release[0] + "'];\n"
		js+="\tif (form_" + release[0] + ".region_" + release[0] + ".value != 'null') {\n"
		js+="\t\tfor (var i = form_" + release[0] + ".region_" + release[0] + ".options.length, id_" + release[0] + " = new Array(form_" + release[0] + ".region_" + release[0] + ".options.length); i > 1; i--)\n"
		js+="\t\t\tid_" + release[0] + "[form_" + release[0] + ".region_" + release[0] + ".options[i - 1].value] = new Array(2);\n\n"

		for img in release[1]:
			js+="\t\tid_" + release[0] + "['" + img['region'] + "']['" + img['arch'] + "'] = '" + img['id'] + "';\n"
		js+="\t}\n"
	for release in args:
		js+="\n\tif (form_" + release[0] + ".region_" + release[0] + ".value != 'null') {\n"
		js+="\t\tvar ami_id = id_" + release[0] + "[form_" + release[0] + ".region_" + release[0] + ".value][form_" + release[0] + ".arch_" + release[0] + ".value];\n"
		js+="\t\tform_" + release[0] + ".amiid_" + release[0] + ".value = ami_id;\n"
		js+="\t\tvar url = 'https://console.aws.amazon.com/ec2/home?region=' + form_" + release[0] + ".region_" + release[0] + ".value + '#launchAmi=' + ami_id;\n"
		js+="\t\tdocument.getElementById('amihref_" + release[0] + "').href = url;\n"
		js+="\t\tdocument.getElementById('amihref_" + release[0] + "').style.visibility='visible';\n"
		js+="\t} else {\n"
		js+="\t\tform_" + release[0] + ".amiid_" + release[0] + ".value = '';\n"
		js+="\t\tdocument.getElementById('amihref_" + release[0] + "').href = '';\n"
		js+="\t\tdocument.getElementById('amihref_" + release[0] + "').style.visibility='hidden';\n"
		js+="\t}\n"

	js+="}\n"
	f = open('out/static/js/cloud_ec2.js', 'w+')
	f.write(js)
	f.close()

gen_js(['18',ec2_f18], ['17',ec2_f17])

?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
  xmlns:py="http://genshi.edgewall.org/"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  py:strip="">

<!-- Genshi Template for Cloud table (without JS) -->
  <py:def function="printrelease(release, array)">
					<h5>${_('Fedora %s ') % release}</h5>
					<table class="verify-live-media">
							<thead>
									<tr>
											<th>${_('Region')}</th>
											<th>${_('Architecture')}</th>
											<th>${_('Root store')}</th>
											<th>${_('AMI ID')}</th>
											<th>${_('Launch')}</th>
									</tr>
							</thead>
							<tbody>
								<py:for each="img in array">
									<tr>
											<td>${img['region']}</td>
											<td>${img['arch']}</td>
											<td>${img['store']}</td>
											<td>${img['id']}</td>
											<td style="vertical-align: middle">
												<a href="https://console.aws.amazon.com/ec2/home?region=${img['region']}#launchAmi=${img['id']}">
												<img style="vertical-align: bottom; display: block; margin: 0 auto" title="${_('Launch AMI instance')}" src="${path}/static/images/cloud_icon.png" />
												</a></td>
									</tr>
								</py:for>
							</tbody>
					</table>

  </py:def>
<!-- /end Genshi Template for Cloud table (without JS) -->

<!-- Genshi Template for Cloud html form  (with JS) -->
  <py:def function="printform(release, regions)">
            <form id="cloud_options_${release}" class="cloud-options" name="cloud_options_${release}" style="visibility:hidden;">
								<h5>${_('Fedora %s ') % release}</h5>
                <select id="region_${release}" name="region_${release}" onchange="getval();">
                    <option value='null'>${_('Select the nearest region')}</option>
										<py:for each="reg in regions">
                    <option>$reg</option>
										</py:for>
                </select>
                <select id="arch_${release}" onchange="getval();">
                    <option value="x86_64">64 bit (x86_64)</option>
                    <option value="i386">32 bit (i386)</option>
                </select>
                <input type="text" name="AMI ID" id="amiid_${release}" class="ami-box" size="12"/>
								<a href="#clouds" id="amihref_${release}" name="amihref_${release}">
								<img style="vertical-align: bottom;" title="${_('Launch AMI instance')}" src="${path}/static/images/cloud_icon.png" />
								</a>
            </form>

  </py:def>
<!-- /end Genshi Template for Cloud html form  (with JS) -->

						<noscript>
               ${printrelease('18', ec2_f18)}
               ${printrelease('17', ec2_f17)}
						</noscript>

						<!-- If JS enabled -->
               ${printform('18', ec2_f18_regions)}
               ${printform('17', ec2_f17_regions)}
						<!-- /end If JS enabled -->

</html>
